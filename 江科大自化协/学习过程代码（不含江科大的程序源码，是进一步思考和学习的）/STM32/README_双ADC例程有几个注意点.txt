
7-17 ADC（双ADC、同步规则模式、GPIO输入2个、规则组、单次转换+扫描模式、配合DMA、定时器触发ADC）与 7-16 ADC（GPIO输入2个、规则组、单次转换+扫描模式、配合DMA、定时器触发ADC）的对比：

一、DMA转运（无修改）

        （配置上没区别。只是运行时，双ADC的ADC2会将数据放到高16bit）

         单ADC1：              DMA配置为搬运ADC1的，外设地址不自增；转运宽度变为32bit（低16bit有ADC1的数据，高16bit为0x0000，是留给ADC2的）
         双ADC1和IADC2：DMA配置为搬运ADC1的，外设地址不自增；转运宽度变为32bit（低16bit有ADC1的数据，高16bit有ADC2的数据）
         
         看库函数：             ADC_GetConversionValue的返回值是uint16_t类型，                                       源码中显示return (uint16_t) ADCx->DR;，即读取ADC_DR规则数据寄存器，返回低16bit
                                       ADC_GetInjectedConversionValue的返回值是uint16_t类型，                          源码中显示return (uint16_t) (*(__IO uint32_t*)  tmp);，即读取ADC_JDRx注入数据寄存器，返回低16bit
                                       ADC_GetDualModeConversionValue的返回值是uint32_t类型，                      源码中显示return (*(__IO uint32_t *) DR_ADDRESS);，即读取ADC_DR规则数据寄存器，返回整个32bit



二、TIM触发（无修改）

        （没区别。只是由于开启了双模式控制，经过与门，外部触发源触发ADC1的规则组时，也可以触发ADC2的规则组）

         单ADC1：             使用TIM2_CC2触发ADC1
         双ADC1和ADC2：使用TIM2_CC2触发ADC1，ADC2配置为无外部触发源
                                   （但是由于整体ADC外设模式不再是独立模式，而是双ADC模式；
                                       STM32参考手册11.9 图31可以看到，"双模式控制-与门" 置1后，外部触发源触发ADC1的规则组时，也可以触发ADC2的规则组)



三、ADC转换（原来的 "主ADC" 配置不变，增加 "从ADC" 的配置）

        （原来的 "主ADC1" 配置不变，只增加 "从ADC2" 的配置）

          单ADC1：整体ADC外设设置：ADC_Mode_Independent，即独立模式
                          对于ADC1：规则组、单次转换、扫描模式、通道数为2（序列1、2对应使用PA0、PA1）、数据右对齐、定时器TIM2_CC2触发、 ADC1-DMA模式使能


          双ADC1和ADC2：整体ADC外设设置：ADC_Mode_RegSimult，即 ADC1和ADC2运行在 "同步规则" 模式（STM32F10xx参考手册的11.9.2）（相当于GD32F30x的12.5.2 "规则并行" 模式）
                          对于ADC1：规则组、单次转换、扫描模式、通道数为2（序列1、2对应使用PA0、PA1）、数据右对齐、定时器TIM2_CC2触发、 ADC1-DMA模式使能
                          对于ADC2：规则组、单次转换、扫描模式、通道数为2（序列1、2对应便用PA1、PA0）、数据右对齐、无外部触发源、


          实际上，整体ADC外设，不管是 ADC_Mode_Independent 还是 ADC_Mode_RegSimult 或者 其他双ADC模式，都是配置ADC_CR1寄存器的DUALMOD[3:0]位域
                       而且，只有ADC1的CR1寄存器中[19:16]位域才是DUALMOD[3:0]
                           ADC2和ADC3的CR1寄存器中[19:16]位域是保留的




          STM32F10xx参考手册的11.9.2   注意：不要在2个ADC上转换相同的通道（两个ADC在同一个通道上的采样时间不能重叠）
                                                                             因此，这里ADC1和ADC2的序列配置是反过来的（见图33）
                                                                                        我们想一想，ADC1_IN0 和 ADC2_IN0 的外部引脚都是PA0
                                                                                        如果同一时间，ADC1_IN0  (PA0)在序列1上采样、ADC2_IN0  (PA0)在序列1上采样。那么第一次采样，被采样的都是PA0的信号，没有意义啊。
                                                                                        如果同一时间，ADC1_IN0  (PA0)在序列1上采样、ADC2_IN1  (PA1)在序列2上来样，那么第一次采样，被采样的是PA0、PA1的信号，分开了，这样才有意义
                                                                             反过来是比较理想的情况，或者错开也行，保证同一序列rank，对应的ADC1_INx 和 ADC2_INy （x≠y）不同就行了



四、运行观察

          仿真Debug，在DMA中断函数DMA1_Channel1_IRQHandler中，打断点
          每次DMA中断时，说明完成了一轮ADC转换，一轮DMA搬运

          使用Keil的System Viewer Windows，看ADC1的DR规则组数据寄存器（显示低16bit的DATA[15:0]位域、高16bit的ADC2DATA[15:0]位域）
                                                                      看ADC2的DR规则组数据寄存器（显示低16bit的DATA[15:0]位域，不显示高16bit）
                                                      可以看到， ADC2_DR的低16bit的DATA[15:0]位域，总是和ADC1_DR的高16bit的ADC2DATA[15:0]位域。
                                                      即完整的ADC1数据寄存器ADC1_DR中包含了ADC1和ADC2的规则转换数据



五、参考手册理解

          STM32F10xx参考手册-11.9中，有这样的话：
                     注意1：  在双ADC模式里，当转换配置成由 "外部事件触发" 时，用户必须将 "主ADC" 设置成 "某种外部触发源"，"从ADC" 设置成 "无外部触发源（软件触发）"，这样可以防止意外的触发从转换。
                                    但是，"主ADC"和 "从ADC" 的外部触发必须同时被激活。（即，触发信号必须同时到达"主ADC"、"从ADC" ） (这样才能保证转换同步，不然双ADC模式就没意义了)

                     注意2：  在双ADC模式里，为了在 "主ADC" 的数据寄存器上读取 "从ADC"的转换数据，必须使能 "主ADC" 的DMA位，即使 "主ADC" 不使用DMA传输规则通道数据。
                                   我的理解：双ADC模式下，ADC1必须调用ADC_DMACmd(ADC1, ENABLE);
                                                        但是要注意，ADC2不能调用ADC_DMACmd(ADC2, ENABLE);
                                                        因为，只有ADC1才能使用DMA，ADC2没有DMA功能。
                                                        由ADC2转化的数据可以通过双ADC模式，利用ADC1的DMA功能传输



          STM32F10xx参考手册的-11.9中，图31：可以看出，外部触发源可以直接触发 "主ADC1"：
                                                                          但是，如果开启了 "某种双模式控制"，触发源就可以通过 "与门"（1跟x与的结果是x本身），来控制 "从ADC2"
                                                                          毕竟，"主ADC1" 和 "从ADC2" 只是外设名不同，规则组和注入组的触发源都是相同的

                                                                          且 "双模式控制" 会控制两个 "与门"，可以独立控制 "从ADC2" 的规则组、注入组的触发源。因此才有了各种不同的 "双ADC模式"

                                                                          例如，如果只有注入组触发源（主ADC1的注入组触发使能、从ADC2的注入组触发使能），                                  那么，当开启 "双模式控制" 的 "注入组与门" 时，就是 "11.9.1 同步注入模式" 
                                                                          例如，如果只有规则组触发源（主ADC1的规则组触发使能、从ADC2的规则组触发使能），                                  那么，当开启 "双模式控制" 的 "规则组与门" 时，就是 "11.9.2 同步规则模式" 
                                                                          例如，如果既有规则组触发源（主ADC1的规则组触发使能）、又有注入组觖发源（从ADC2的注入组触发使能），那么，当开启 "双模式控制" 的 "注入组与门" 时，就是 "11.9.7 混合的规则/注入同步模式" 
                                                                                 ，如果既有注入组触发源（主ADC1的注入组触发使能）、又有规则组铁发源（从ADC2的规则组触发使能），那么，当开启 "双模式控制" 的 "规则组与门" 时，也是 "11.9.7 混合的规则/注入同步模式" 



          STM32F10xx参考手册的-11.9中，图31的附点1：外部触发信号作用于ADC2，但在本图中没有显示。
                                                                          从这里也可以看出，为了保证同个外部触发源对 "主ADC1" 和 "从ADC2"，"从ADC2" 必须配置为 "无外部触发源"，从而避免错误的触发引起不必要的转换。
                                                                          否则，如果使用 "TIM2_CC2" 对 "主ADC1" 和 "从ADC2" 触发（双模式开启：同步规则），但是又将 "从ADC2" 配置成了 "TIM4_CC4" 触发，就相当于 "从ADC2" 有两个触发源，会有冲突。
                                                                          因此，图31才没画出来 "从ADC2" 的外部触发信号。就是为了提醒：双模式下, "从ADC2" 要配置为 "无外部触发源ADC_ExternalTrigConv_None"



          STM32F10xx参考手册的-11.9中，图31的附点2：在某些双ADC模式中，在完整的ADC1数据寄存器（ADC1_DR）中包含了ADC1和ADC2的规则转换数据。
                                                                          是不是说明，还有某些双ADC模式中，并不是这样?
                                                                          比如，如果是 "同步注入模式ADC_Mode_InjecSimult"，而且输入通道有2个，
                                                                          那么，完整的ADC1注入数据寄存器1（ADC1_JDR1）中包含了ADC1和ADC2的序列1的注入转换数据？
                                                                                    完整的ADC1注入数据寄存器2（ADC1_JDR2）中包含了ADC1和ADC2的序列2的注入转换数据？



          STM32F10xx参考手册的-11.12.2 ADC控制寄存器1(ADC_CR1)：DUALMOD[3:0]位域的备注
                                                               在双模式中，改变通道的配置会产生一个重新开始的条件，这将导致同步丢失。建议在进行任何配置改变前关闭双模式。




六、8种模式

       注意看 《GD32F30x手册的12.5》 和 《STM32F10xx手册的11.9》，将待配置参数 和 每种双模式 对应起来。













































